<!DOCTYPE html>
<html lang="en" class="govuk-template">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gov.UK Collaboration Tool & KPI Dashboard</title>
    <link href="/public/stylesheets/application.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Custom layout styles only */
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            margin: 0;
        }

        /* Layout */
        .container { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 300px; background: #fff; border-right: 1px solid #b1b4b6; padding: 20px; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.05); }
        .preview-area { flex: 1; padding: 40px; background: #fff; overflow-y: auto; display: flex; flex-direction: column; }
        .dashboard-section { 
            height: 350px; 
            min-height: 50px;
            max-height: 80vh;
            background: #f3f2f1; 
            border-top: 1px solid #b1b4b6; 
            padding: 20px; 
            display: flex; 
            gap: 20px;
            position: relative;
            transition: height 0.3s ease;
        }
        .dashboard-section.collapsed {
            height: 50px;
            overflow: hidden;
        }
        .dashboard-resize-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 10px;
            cursor: ns-resize;
            background: #b1b4b6;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }
        .dashboard-resize-handle:hover {
            background: #505a5f;
        }
        .dashboard-resize-handle::after {
            content: '⋯';
            color: #fff;
            font-size: 18px;
            letter-spacing: 2px;
        }
        .dashboard-toggle-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            z-index: 11;
        }

        /* Date Input custom styling */
        /* Date Input custom styling */
        .govuk-date-input { display: flex; gap: 20px; margin-bottom: 30px; }
        .govuk-date-item { display: flex; flex-direction: column; }
        .govuk-input--width-4 { width: 70px; }

        /* UI Controls */
        h2 { margin-top: 0; border-bottom: 2px solid #00703c; padding-bottom: 10px; font-size: 20px; }
        .control-group { margin-bottom: 20px; }
        .control-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 14px; }
        .control-group select, .control-group input[type="text"] { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* File display area - remove borders from filename */
        #fileDisplayArea h2 { border-bottom: none; padding-bottom: 0; }
        
        /* Dashboard Card */
        .kpi-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .kpi-card h3 { font-size: 16px; margin: 0 0 10px 0; color: #505a5f; }
        .chart-container { position: relative; width: 100%; height: 100%; }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 4px;
        }
        .modal-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 2px solid #0b0c0c;
            font-size: 19px;
        }
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        .modal-button {
            flex: 1;
            padding: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border: none;
        }
        .modal-button-submit {
            background-color: #00703c;
            color: white;
        }
        .modal-button-cancel {
            background-color: #b1b4b6;
            color: #0b0c0c;
        }
    </style>
</head>
<body>

    <!-- Modal for name input -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top: 0;">Submit Your Vote</h2>
            <label for="nameInput" style="font-size: 16px; margin-bottom: 5px; display: block;">Please enter your first name:</label>
            <input type="text" id="nameInput" class="modal-input" placeholder="Enter your first name">
            
            <label for="rationaleInput" style="font-size: 16px; margin-bottom: 5px; margin-top: 15px; display: block;">Please explain your choice (optional):</label>
            <textarea id="rationaleInput" class="modal-input" placeholder="Why did you choose this option?" rows="4" style="resize: vertical; font-family: inherit;"></textarea>
            
            <div class="modal-buttons">
                <button class="modal-button modal-button-cancel" onclick="closeModal()">Cancel</button>
                <button class="modal-button modal-button-submit" onclick="confirmSubmit()">Submit Vote</button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <h2>Page Configurer</h2>
            <p style="font-size: 14px; color: #505a5f;">Adjust the settings to select your preferred layout</p>

            <div class="govuk-form-group">
                <label class="govuk-label" for="inputCaption">
                    Caption Text
                </label>
                <input class="govuk-input" id="inputCaption" name="inputCaption" type="text" value="Appeal 12345 - Manage documents" oninput="updatePreview()">
            </div>

            <div class="govuk-form-group">
                <label class="govuk-label" for="inputHeading">
                    Heading Text
                </label>
                <input class="govuk-input" id="inputHeading" name="inputHeading" type="text" value="Date received for appellant costs withdrawal" oninput="updatePreview()">
            </div>

            <div class="govuk-form-group">
                <label class="govuk-label" for="selectHeadingSize">
                    Heading Size
                </label>
                <select class="govuk-select" id="selectHeadingSize" name="selectHeadingSize" onchange="updatePreview()">
                    <option value="govuk-heading-xl">Extra Large</option>
                    <option value="govuk-heading-l" selected>Large</option>
                    <option value="govuk-heading-m">Medium</option>
                </select>
            </div>

            <div class="govuk-form-group">
                <label class="govuk-label" for="selectFileStyle">
                    Filename Display Style
                </label>
                <select class="govuk-select" id="selectFileStyle" name="selectFileStyle" onchange="updatePreview()">
                    <option value="standard">Standard Text</option>
                    <option value="bold">Bold Text</option>
                    <option value="inset">Inset Text / Grey Bar</option>
                </select>
            </div>
        </div>

        <div class="preview-area">
            <a href="#" class="govuk-link" style="margin-bottom: 20px;">Back</a>

            <span id="previewCaption" class="govuk-caption-l">Appeal 12345 - Manage documents</span>
            <h1 id="previewHeading" class="govuk-heading-l">Date received for appellant costs withdrawal</h1>

            <div id="fileDisplayArea" class="govuk-body">
                Screenshot 2025-12-23 at 15.21.16.png
            </div>

            <div class="govuk-form-group">
                <fieldset class="govuk-fieldset" role="group" aria-describedby="date-hint">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Enter date received
                    </legend>
                    <div id="date-hint" class="govuk-hint">
                        For example, 12 12 2025
                    </div>
                    <div class="govuk-date-input" id="date-input">
                        <div class="govuk-date-input__item">
                            <div class="govuk-form-group">
                                <label class="govuk-label govuk-date-input__label" for="day">
                                    Day
                                </label>
                                <input class="govuk-input govuk-date-input__input govuk-input--width-2" id="day" name="day" type="text" inputmode="numeric">
                            </div>
                        </div>
                        <div class="govuk-date-input__item">
                            <div class="govuk-form-group">
                                <label class="govuk-label govuk-date-input__label" for="month">
                                    Month
                                </label>
                                <input class="govuk-input govuk-date-input__input govuk-input--width-2" id="month" name="month" type="text" inputmode="numeric">
                            </div>
                        </div>
                        <div class="govuk-date-input__item">
                            <div class="govuk-form-group">
                                <label class="govuk-label govuk-date-input__label" for="year">
                                    Year
                                </label>
                                <input class="govuk-input govuk-date-input__input govuk-input--width-4" id="year" name="year" type="text" inputmode="numeric">
                            </div>
                        </div>
                    </div>
                </fieldset>
            </div>

            <div>
                <button class="govuk-button" data-module="govuk-button" onclick="openModal()">Submit your vote</button>
            </div>
            
            <p style="margin-top: 50px; font-size: 14px; color: #505a5f; border-top: 1px solid #ccc; padding-top:10px;">
                <em>Clicking "Submit your vote" will prompt for your first name and record your preferences. All data is saved in memory during this session.</em>
                <br><br>
                <button onclick="clearAllData()" style="background: #d4351c; color: white; border: none; padding: 8px 12px; cursor: pointer; font-size: 14px; margin-top: 10px;">Clear All Data</button>
            </p>
        </div>
    </div>

    <div class="dashboard-section" id="dashboardSection">
        <div class="dashboard-resize-handle" id="resizeHandle"></div>
        <button class="dashboard-toggle-btn" id="toggleBtn" onclick="toggleDashboard()">▼ Collapse</button>
        <div class="kpi-card">
            <h3>Total Submissions</h3>
            <div style="font-size: 64px; font-weight: bold; color: #0b0c0c; margin: auto;" id="totalCount">0</div>
        </div>
        <div class="kpi-card">
            <h3>Preferred Heading Size</h3>
            <div class="chart-container">
                <canvas id="headingChart"></canvas>
            </div>
        </div>
        <div class="kpi-card">
            <h3>Preferred Filename Style</h3>
            <div class="chart-container">
                <canvas id="styleChart"></canvas>
            </div>
        </div>
        <div class="kpi-card" style="flex: 2; overflow-y: auto;">
            <h3>Vote History</h3>
            <div id="voteHistory" style="width: 100%; text-align: left; font-size: 14px;">
                <p style="color: #505a5f; font-style: italic;">No votes yet</p>
            </div>
        </div>
    </div>

    <script>
        // --- 1. PREVIEW LOGIC ---
        function updatePreview() {
            const caption = document.getElementById('inputCaption').value;
            const heading = document.getElementById('inputHeading').value;
            const headingSize = document.getElementById('selectHeadingSize').value;
            const fileStyle = document.getElementById('selectFileStyle').value;

            document.getElementById('previewCaption').textContent = caption;
            
            const h1 = document.getElementById('previewHeading');
            h1.textContent = heading;
            h1.className = '';
            h1.classList.add(headingSize);

            const fileArea = document.getElementById('fileDisplayArea');
            fileArea.className = 'govuk-body';
            const filename = 'Screenshot 2025-12-23 at 15.21.16.png';

            if (fileStyle === 'bold') {
                fileArea.innerHTML = '<h2 class="govuk-heading-m">' + filename + '</h2>';
                fileArea.classList.remove('govuk-inset-text');
            } else if (fileStyle === 'inset') {
                fileArea.innerHTML = filename;
                fileArea.classList.add('govuk-inset-text');
            } else {
                fileArea.innerHTML = filename;
            }
        }

        // --- 2. DATA TRACKING LOGIC ---
        let stats = {
            total: 0,
            headingSizes: { 'govuk-heading-xl': 0, 'govuk-heading-l': 0, 'govuk-heading-m': 0 },
            fileStyles: { 'standard': 0, 'bold': 0, 'inset': 0 },
            votes: []
        };

        // Modal functions
        function openModal() {
            document.getElementById('nameModal').style.display = 'block';
            document.getElementById('nameInput').value = '';
            document.getElementById('rationaleInput').value = '';
            document.getElementById('nameInput').focus();
        }

        function closeModal() {
            document.getElementById('nameModal').style.display = 'none';
        }

        function confirmSubmit() {
            const firstName = document.getElementById('nameInput').value;
            const rationale = document.getElementById('rationaleInput').value;
            if (!firstName || firstName.trim() === '') {
                alert("First name is required to submit your vote.");
                return;
            }

            closeModal();
            submitVote(firstName.trim(), rationale.trim());
        }

        // Handle Enter key in modal
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('nameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmSubmit();
                }
            });
        });

        function submitVote(firstName, rationale) {
            const currentHeadingSize = document.getElementById('selectHeadingSize').value;
            const currentFileStyle = document.getElementById('selectFileStyle').value;
            const currentCaption = document.getElementById('inputCaption').value;
            const currentHeading = document.getElementById('inputHeading').value;

            stats.total++;
            stats.headingSizes[currentHeadingSize]++;
            stats.fileStyles[currentFileStyle]++;
            
            const headingSizeLabel = currentHeadingSize === 'govuk-heading-xl' ? 'XL' : 
                                    currentHeadingSize === 'govuk-heading-l' ? 'Large' : 'Medium';
            const fileStyleLabel = currentFileStyle === 'standard' ? 'Standard' : 
                                  currentFileStyle === 'bold' ? 'Bold' : 'Inset (Grey Bar)';
            
            stats.votes.push({
                name: firstName,
                caption: currentCaption,
                heading: currentHeading,
                headingSize: headingSizeLabel,
                fileStyle: fileStyleLabel,
                rationale: rationale || 'No rationale provided',
                timestamp: new Date().toLocaleString()
            });

            document.getElementById('totalCount').innerText = stats.total;
            updateCharts();
            updateVoteHistory();
            
            const btn = document.querySelector('.govuk-button');
            const originalText = btn.innerText;
            btn.innerText = "Vote Recorded!";
            btn.style.backgroundColor = "#005a30";
            setTimeout(() => {
                btn.innerText = originalText;
                btn.style.backgroundColor = "#00703c";
            }, 1500);
        }

        // --- 3. CHART.JS VISUALIZATION ---
        let headingChartInst = null;
        let styleChartInst = null;

        function initCharts() {
            const ctxHeading = document.getElementById('headingChart').getContext('2d');
            const ctxStyle = document.getElementById('styleChart').getContext('2d');

            headingChartInst = new Chart(ctxHeading, {
                type: 'pie',
                data: {
                    labels: ['XL', 'Large', 'Medium'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#f47738', '#1d70b8', '#00703c']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            styleChartInst = new Chart(ctxStyle, {
                type: 'bar',
                data: {
                    labels: ['Standard', 'Bold', 'Inset (Grey Bar)'],
                    datasets: [{
                        label: 'Votes',
                        data: [0, 0, 0],
                        backgroundColor: ['#b1b4b6', '#0b0c0c', '#f47738']
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } } }
                }
            });
        }

        function updateCharts() {
            headingChartInst.data.datasets[0].data = [
                stats.headingSizes['govuk-heading-xl'],
                stats.headingSizes['govuk-heading-l'],
                stats.headingSizes['govuk-heading-m']
            ];
            headingChartInst.update();

            styleChartInst.data.datasets[0].data = [
                stats.fileStyles['standard'],
                stats.fileStyles['bold'],
                stats.fileStyles['inset']
            ];
            styleChartInst.update();
        }

        function updateVoteHistory() {
            const historyDiv = document.getElementById('voteHistory');
            if (stats.votes.length === 0) {
                historyDiv.innerHTML = '<p style="color: #505a5f; font-style: italic;">No votes yet</p>';
                return;
            }
            
            const recentVotes = [...stats.votes].reverse().slice(0, 20);
            let html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<tr style="border-bottom: 2px solid #b1b4b6; font-weight: bold;"><td>Name</td><td>Caption</td><td>Heading</td><td>Size</td><td>Style</td><td>Rationale</td></tr>';
            
            recentVotes.forEach((vote, index) => {
                const bgColor = index % 2 === 0 ? '#f8f8f8' : 'white';
                html += `<tr style="background: ${bgColor}; border-bottom: 1px solid #e8e8e8;">
                    <td style="padding: 8px; vertical-align: top;">${vote.name}</td>
                    <td style="padding: 8px; vertical-align: top; max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${vote.caption}</td>
                    <td style="padding: 8px; vertical-align: top; max-width: 120px; overflow: hidden; text-overflow: ellipsis;">${vote.heading}</td>
                    <td style="padding: 8px; vertical-align: top;">${vote.headingSize}</td>
                    <td style="padding: 8px; vertical-align: top;">${vote.fileStyle}</td>
                    <td style="padding: 8px; vertical-align: top; max-width: 200px;">${vote.rationale}</td>
                </tr>`;
            });
            
            html += '</table>';
            if (stats.votes.length > 20) {
                html += `<p style="margin-top: 10px; font-size: 12px; color: #505a5f;">Showing 20 most recent votes (${stats.votes.length} total)</p>`;
            }
            historyDiv.innerHTML = html;
        }

        // Clear all saved data
        function clearAllData() {
            if (confirm('Are you sure you want to clear all voting data? This cannot be undone.')) {
                stats = {
                    total: 0,
                    headingSizes: { 'govuk-heading-xl': 0, 'govuk-heading-l': 0, 'govuk-heading-m': 0 },
                    fileStyles: { 'standard': 0, 'bold': 0, 'inset': 0 },
                    votes: []
                };
                document.getElementById('totalCount').innerText = '0';
                updateCharts();
                updateVoteHistory();
                alert('All data has been cleared.');
            }
        }

        window.onload = function() {
            updatePreview();
            initCharts();
            initDashboardResize();
        };

        // Dashboard expand/collapse and resize functionality
        function toggleDashboard() {
            const dashboard = document.getElementById('dashboardSection');
            const btn = document.getElementById('toggleBtn');
            
            if (dashboard.classList.contains('collapsed')) {
                dashboard.classList.remove('collapsed');
                dashboard.style.height = '350px';
                btn.textContent = '▼ Collapse';
            } else {
                dashboard.classList.add('collapsed');
                btn.textContent = '▲ Expand';
            }
        }

        function initDashboardResize() {
            const dashboard = document.getElementById('dashboardSection');
            const handle = document.getElementById('resizeHandle');
            let isResizing = false;
            let startY = 0;
            let startHeight = 0;

            handle.addEventListener('mousedown', function(e) {
                isResizing = true;
                startY = e.clientY;
                startHeight = dashboard.offsetHeight;
                dashboard.style.transition = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;
                
                const deltaY = startY - e.clientY;
                const newHeight = startHeight + deltaY;
                
                if (newHeight >= 50 && newHeight <= window.innerHeight * 0.8) {
                    dashboard.style.height = newHeight + 'px';
                    dashboard.classList.remove('collapsed');
                    document.getElementById('toggleBtn').textContent = '▼ Collapse';
                }
            });

            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    dashboard.style.transition = 'height 0.3s ease';
                }
            });
        }
    </script>
</body>
</html>